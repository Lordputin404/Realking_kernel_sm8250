name: Build RealKing Kernel (WebX Clang 19.1.5 + HyperOS Auto-Select)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout RK Kernel (root repo)
        uses: actions/checkout@v4
        with:
          ref: m-staging
          fetch-depth: 1
          submodules: false
          clean: true
          set-safe-directory: true

      # 1️⃣ Inject SukiSU code (source-level integration)
      - name: Integrate SukiSU (Manual setup)
        run: |
          curl -LSs "https://raw.githubusercontent.com/ApartTUSITU/SukiSU-Ultra/main/kernel/setup.sh" | bash -

      # 2️⃣ Prepare build_kernel.sh (NON-interactive, CI safe)
      - name: Prepare build_kernel.sh (Auto-select choices)
        run: |
          chmod +x build_kernel.sh
          sed -i 's|read -p "Enter the number of your choice: " clang_choice|clang_choice=${CLANG_CHOICE:-2}|g' build_kernel.sh
          sed -i 's|read -p "Enter the number of your choice: " build_choice|build_choice=${BUILD_CHOICE:-1}|g' build_kernel.sh

      # 3️⃣ Run kernel build (defconfig + full build + ZIP creation)
      - name: Run Kernel Build Script
        run: |
          export CLANG_CHOICE=2
          export BUILD_CHOICE=1
          ./build_kernel.sh

      - name: Apply SukiSU KPM patch
        run: |
          cd out/arch/arm64/boot

          # Decompress Image.gz -> Image (required for KPM)
          gunzip -kf Image.gz

          wget https://github.com/SukiSU-Ultra/SukiSU_KernelPatch_patch/releases/download/0.12.2/patch_linux
          chmod +x patch_linux
          ./patch_linux

          # Replace original Image with patched one
          rm -f Image
          mv oImage Image

          # Re-compress patched Image
          gzip -f Image

      # 5️⃣ Replace patched Image inside flashable ZIP (CRITICAL STEP)
      - name: Inject patched kernel into ZIP
        run: |
          ZIP_FILE=$(ls *.zip | head -n 1)
          mkdir zipfix
          unzip "$ZIP_FILE" -d zipfix

          # Replace kernel image (handle both Image & Image.gz cases)
          if [ -f "zipfix/Image.gz" ]; then
            gzip -c out/arch/arm64/boot/Image > zipfix/Image.gz
          elif [ -f "zipfix/Image" ]; then
            cp out/arch/arm64/boot/Image zipfix/Image
          else
            echo "❌ No kernel Image found inside ZIP"
            exit 1
          fi

          rm "$ZIP_FILE"
          cd zipfix
          zip -r "../$ZIP_FILE" *
          cd ..
          rm -rf zipfix

      # 6️⃣ Upload FINAL patched ZIP
      - name: Upload Kernel ZIP
        uses: actions/upload-artifact@v4
        with:
          name: RealKing-Kernel-SukiSU-KPM
          path: "*.zip"
