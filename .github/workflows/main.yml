name: Build RealKing Kernel (WebX Clang 19.1.5 + KernelSU-Next)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Kernel (repo root)
        uses: actions/checkout@v4
        with:
          ref: m-staging
          fetch-depth: 1
          submodules: false
          clean: true

      - name: Install Dependencies (Python2 bypass + ncurses)
        run: |
          sudo apt update -y
          sudo apt install -y --no-install-recommends flex libncurses-dev perl wget zstd lld llvm
          sudo ln -sf /usr/bin/python3 /usr/bin/python2
          echo "Python2 calls bypassed using Python3."

      - name: Download & Extract WebX Clang 19.1.5
        run: |
          CLANG_URL=$(curl -s https://raw.githubusercontent.com/v3kt0r-87/Clang-Stable/main/clang-weebx.txt)
          echo "Resolved Clang URL: $CLANG_URL"
          wget "$CLANG_URL" -O weebx-clang.tar.gz
          mkdir -p clang
          tar -xvf weebx-clang.tar.gz -C clang
          echo "CLANG_PATH=$(pwd)/clang/bin" >> $GITHUB_ENV
          rm -f weebx-clang.tar.gz
          echo "WebX Clang setup completed."

      - name: Build Kernel (no zip, no boot.img)
        run: |
          echo "Using toolchain: $CLANG_PATH"
          export PATH="${{ env.CLANG_PATH }}:$PATH:/usr/bin"
          export ARCH=arm64
          export SUBARCH=ARM64
          export KBUILD_BUILD_USER="lordputin"
          export KBUILD_BUILD_HOST="ubuntu"
          export KBUILD_COMPILER_STRING="$(${{ env.CLANG_PATH }}/clang --version | head -n1 | perl -pe 's/\\(http.*?\\)//g' | sed -e 's/  */ /g')"

          echo "**** Kernel defconfig is set to munch_defconfig ****"
          make ARCH=arm64 munch_defconfig O=out CC=clang || true
          make O=out oldconfig || true
          make -j$(nproc --all) O=out \
            CC=clang \
            ARCH=arm64 \
            CROSS_COMPILE=aarch64-linux-gnu- \
            NM=llvm-nm \
            OBJDUMP=llvm-objdump \
            STRIP=llvm-strip \
            LD=ld.lld \
            LLVM=1 LLVM_IAS=1 || true

      - name: Upload Kernel Image (Image.gz only)
        uses: actions/upload-artifact@v4
        with:
          name: Image.gz
          path: out/arch/arm64/boot/Image.gz
